<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sector Demand Details - {{ selected_sector }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 1000px; margin: 20px auto; }
        h1, h2, h3 { color: #333; text-align: center; }
        ul.flash-messages { list-style: none; padding: 0; margin-bottom: 15px; }
        li.success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 5px; }
        li.error, li.danger { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 5px; }
        li.warning { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin-bottom: 5px; }
        li.info { background-color: #cce5ff; color: #004085; padding: 10px; border-radius: 4px; margin-bottom: 5px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        td.number, th.number { text-align: right; }

        .nav-links { margin-top: 20px; margin-bottom: 20px; text-align: center; }
        .nav-links a, .sector-nav a { margin: 0 10px; text-decoration: none; color: #007bff; padding: 5px 10px; border-radius: 4px; background-color: #e9ecef; }
        .nav-links a:hover, .sector-nav a:hover { text-decoration: underline; background-color: #d0d3d6;}
        .sector-nav a.active { font-weight: bold; background-color: #007bff; color: white; }

        .project-info { margin-bottom: 15px; padding: 10px; background-color: #e9ecef; border-radius: 4px; text-align: center; }
        .chart-container { width: 95%; max-width: 900px; margin: 20px auto; padding:10px; border: 1px solid #ddd; border-radius:5px; background-color:#fdfdfd;}
        /* Sidebar Styles */
        .sidebar {
            height: 100%; width: 300px; /* Adjusted width */
            position: fixed; z-index: 100; /* Ensure sidebar is on top */
            top: 0; right: -320px; /* Initially hidden, increased to prevent shadow issues */
            background-color: #f8f9fa;
            overflow-y: auto; /* Allow scrolling within sidebar */
            padding-top: 20px;
            transition: right 0.3s ease-in-out;
            border-left: 1px solid #ced4da;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar.open { right: 0; }
        .sidebar h3 {
            padding: 0 15px 10px 15px;
            margin-top:0;
            border-bottom: 1px solid #ddd;
            font-size: 1.3em;
            text-align: left;
        }
        .sidebar .sector-config-item { margin-bottom: 12px; padding: 0px 15px; }
        .sidebar label { display: block; margin-bottom: 4px; font-weight: bold; font-size:0.95em; }
        .sidebar select { width: 100%; padding: 8px; margin-bottom: 8px; border-radius:4px; border:1px solid #ccc; box-sizing: border-box;}
        .sidebar .save-button-container {
            padding: 15px;
            border-top: 1px solid #ddd;
            margin-top:15px;
            background-color: #e9ecef;
            text-align: right;
        }
        .sidebar .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
            color: #888;
        }
        .sidebar .close-btn:hover { color: #000; }

        /* Main content area adjustments (optional, if sidebar pushes content) */
        .main-content-area { transition: margin-right .3s ease-in-out; }
        /* .main-content-area.shifted { margin-right: 300px; } */

        #openSidebarBtn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index:50; /* Ensure button is above main content but below open sidebar */
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
         #openSidebarBtn:hover { background-color: #0056b3; }
         .primary-model-section-placeholder { margin-top: 20px; padding: 15px; border: 1px solid #e0e0e0; background-color: #f5f5f5; border-radius: 5px; text-align:center;}

    </style>
</head>
<body>
    <button id="openSidebarBtn">Configure Primary Models</button>

    <!-- Sidebar for Primary Model Selection -->
    <div id="primaryModelSidebar" class="sidebar">
        <a href="javascript:void(0)" class="close-btn" id="closeSidebarBtn">&times;</a>
        <h3>Select Primary Model</h3>
        <form id="primaryModelForm">
            {% for sector_item_sidebar in available_sectors %} {# Use a different loop var name if needed to avoid conflict #}
            <div class="sector-config-item">
                <label for="primary_model_{{ sector_item_sidebar }}">{{ sector_item_sidebar }}:</label>
                <select name="primary_model_{{ sector_item_sidebar }}" id="primary_model_{{ sector_item_sidebar }}">
                    <option value="">-- Auto (Default Logic) --</option> {# Changed default option #}
                    {% set current_primary = current_display_settings.get('primary_models', {}).get(sector_item_sidebar) %}
                    {% for model_option in all_models_in_data_for_all_sectors.get(sector_item_sidebar, []) %}
                        <option value="{{ model_option }}" {% if model_option == current_primary %}selected{% endif %}>
                            {{ model_option }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}
            <div class="save-button-container">
                <button type="button" id="savePrimaryModelsBtn" class="button-link" style="background-color: #28a745;">Save Selections</button>
            </div>
        </form>
    </div>

    <div class="container main-content-area"> {# Added main-content-area wrapper #}
        <h1>Sector Demand Details</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {% if not current_project_name_g %}
            <p class="warning">No project is currently loaded. Please load or create a project first from the <a href="{{ url_for('main.home') }}">home page</a>.</p>
        {% else %}
            <div class="project-info">
                Project: <strong>{{ current_project_name_g }}</strong> | Scenario: <strong>{{ display_scenario_name }}</strong>
            </div>

            <div class="sector-nav">
                <strong>Select Sector:</strong>
                {% for sector_item in available_sectors %}
                    <a href="{{ url_for('demand_projection.view_sector_detail_route', scenario_filename=scenario_filename, sector_name=sector_item) }}"
                       class="{{ 'active' if sector_item == selected_sector else '' }}">
                        {{ sector_item }}
                    </a>
                {% endfor %}
            </div>
            <hr>

            {% if selected_sector %}
                <h2>Details for Sector: {{ selected_sector }}</h2>

                <div class="chart-container">
                    <canvas id="forecastChart"></canvas>
                </div>

                <h3>Data Table</h3>
                {% if not sector_data_df.empty %}
                <table>
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Model</th>
                            <th class="number">Value</th>
                            <th class="number">Lower Bound</th>
                            <th class="number">Upper Bound</th>
                            <th>Comment</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in sector_data_df.itertuples() %}
                        <tr>
                            <td>{{ row.Year }}</td>
                            <td>{{ row.Model }}</td>
                            <td class="number">{{ "%.2f"|format(row.Value) if row.Value is not none else 'N/A' }}</td>
                            <td class="number">{{ "%.2f"|format(row.Lower_Bound) if row.Lower_Bound is not none else 'N/A' }}</td>
                            <td class="number">{{ "%.2f"|format(row.Upper_Bound) if row.Upper_Bound is not none else 'N/A' }}</td>
                            <td>{{ row.Comment | default('', true) }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No data available for this sector in the selected scenario.</p>
                {% endif %}

                <div class="primary-model-section-placeholder"> {# Changed class to avoid conflict if any #}
                    <h3>Primary Model Selection for {{ selected_sector }}</h3>
                <p>Current Primary Model for {{ selected_sector }}: <strong id="currentPrimaryModelDisplay">{{ primary_model_selected | default('None (Default Logic)') }}</strong></p>
                <p>Available models in this data for {{ selected_sector }}: {{ all_models_in_data | join(', ') if all_models_in_data else 'None' }}</p>
                <p><em>Use the "Configure Primary Models" button (top right) to open the selection panel and save your choices.</em></p>
                </div>

            {% else %}
                <p class="info">Please select a sector to view details.</p>
            {% endif %}

            <div class="nav-links">
                <a href="{{ url_for('demand_projection.results_page_route', scenario_id=scenario_filename) }}">Back to Scenario Results List</a>
                <a href="{{ url_for('main.home') }}">Back to Project Home</a>
            </div>

        {% endif %} {# End current_project_name_g check #}
    </div>

<script>
    // Chart.js plotting logic
    const chartCanvas = document.getElementById('forecastChart'); // Renamed for clarity
    const sectorDataJsonForChart = JSON.parse({{ sector_data_json | safe }}); // Renamed for clarity

    let forecastChartInstance = null; // To store the chart instance for potential updates/destruction

    function renderForecastChart(chartEl, data, selectedSectorName) {
        if (forecastChartInstance) {
            forecastChartInstance.destroy(); // Destroy previous chart instance if exists
        }
        if (!chartEl || !data || data.length === 0) {
            if (chartEl) {
                const canvasCtx = chartEl.getContext('2d');
                canvasCtx.clearRect(0, 0, chartEl.width, chartEl.height); // Clear canvas
                canvasCtx.font = '16px Arial';
                canvasCtx.textAlign = 'center';
                canvasCtx.fillText('No data available to display chart for this sector.', chartEl.width / 2, chartEl.height / 2);
            }
            return;
        }

        const models = [...new Set(data.map(item => item.Model))];
        const years = [...new Set(data.map(item => item.Year))].sort((a, b) => a - b);

        const datasets = models.map(model => {
            const modelData = data.filter(item => item.Model === model);
            const dataPoints = years.map(year => {
                const point = modelData.find(item => item.Year === year);
                return point ? point.Value : null;
            });

            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);

            return {
                label: model,
                data: dataPoints,
                borderColor: `rgb(${r}, ${g}, ${b})`,
                backgroundColor: `rgba(${r}, ${g}, ${b}, 0.1)`,
                fill: false,
                tension: 0.1
            };
        });

        forecastChartInstance = new Chart(chartEl, { // Assign to the instance variable
            type: 'line',
            data: {
                labels: years,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Forecast Models Comparison for Sector: ' + selectedSectorName
                    },
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Year'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Demand Value'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Initial render
    renderForecastChart(chartCanvas, sectorDataJsonForChart, "{{ selected_sector | e }}");


    // Sidebar JavaScript
    const openSidebarBtn = document.getElementById('openSidebarBtn');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');
    const sidebar = document.getElementById('primaryModelSidebar');
    // const mainContent = document.querySelector('.main-content-area'); // Optional

    if (openSidebarBtn && sidebar) {
        openSidebarBtn.addEventListener('click', function() {
            sidebar.classList.add('open');
            // if (mainContent) mainContent.classList.add('shifted'); // Optional
        });
    }

    if (closeSidebarBtn && sidebar) {
        closeSidebarBtn.addEventListener('click', function() {
            sidebar.classList.remove('open');
            // if (mainContent) mainContent.classList.remove('shifted'); // Optional
        });
    }

    // Placeholder for savePrimaryModelsBtn click listener (Step 6)
    const saveBtn = document.getElementById('savePrimaryModelsBtn');
    if(saveBtn) {
        saveBtn.addEventListener('click', function() {
            const form = document.getElementById('primaryModelForm');
            const selections = {};
            const scenarioFilename = '{{ scenario_filename | e }}'; // Escape for JS string
            const availableSectorsForJS = {{ available_sectors | tojson | safe }};

            availableSectorsForJS.forEach(function(sectorName) {
                // Construct ID similar to how it's generated in the form for selects
                // This assumes sector_item_sidebar was used in the form loop for the ID
                const selectElement = document.getElementById('primary_model_' + sectorName);
                if (selectElement) {
                    selections[sectorName] = selectElement.value; // Empty string if "-- Auto --"
                }
            });

            // Make sure the URL is correctly generated by Flask's url_for
            const saveUrl = "{{ url_for('demand_projection.save_primary_models_route', scenario_filename='PLACEHOLDER_SCENARIO_FILENAME') }}".replace('PLACEHOLDER_SCENARIO_FILENAME', encodeURIComponent(scenarioFilename));

            fetch(saveUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Add CSRF token header here if required by your Flask setup
                    // 'X-CSRFToken': '{{ csrf_token() }}' // If using Flask-WTF
                },
                body: JSON.stringify(selections)
            })
            .then(response => {
                // Check if response is ok (status in the range 200-299)
                if (response.ok) {
                    return response.json();
                } else {
                    // Attempt to parse error response, or create a generic error
                    return response.json().then(errData => {
                        throw new Error(errData.message || `Server responded with status: ${response.status}`);
                    }).catch(() => { // Catch if error response itself is not JSON or other parsing error
                        throw new Error(`Server responded with status: ${response.status}`);
                    });
                }
            })
            .then(data => {
                alert(data.message); // Or use a more sophisticated notification system

                // Update the display for the currently selected sector if it was part of the save
                const currentSelectedSectorForDisplay = '{{ selected_sector | e }}';
                const primaryModelDisplaySpan = document.getElementById('currentPrimaryModelDisplay'); // Ensure this ID exists

                if (primaryModelDisplaySpan && selections.hasOwnProperty(currentSelectedSectorForDisplay)) {
                    primaryModelDisplaySpan.textContent = selections[currentSelectedSectorForDisplay] || 'None (Default Logic)';
                }
                // Optionally, close sidebar after successful save
                // document.getElementById('primaryModelSidebar').classList.remove('open');
            })
            .catch(error => {
                console.error('Error saving primary model selections:', error);
                alert('An error occurred while saving selections: ' + error.message);
            });
        });
    }

</script>
</body>
</html>
        const models = [...new Set(sectorDataJson.map(item => item.Model))];
        const years = [...new Set(sectorDataJson.map(item => item.Year))].sort((a, b) => a - b);

        const datasets = models.map(model => {
            const modelData = sectorDataJson.filter(item => item.Model === model);
            const dataPoints = years.map(year => {
                const point = modelData.find(item => item.Year === year);
                return point ? point.Value : null; // Use null for missing data points in a series
            });

            // Basic distinct colors - can be improved
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);

            return {
                label: model,
                data: dataPoints,
                borderColor: `rgb(${r}, ${g}, ${b})`,
                backgroundColor: `rgba(${r}, ${g}, ${b}, 0.1)`, // For area under line if needed
                fill: false,
                tension: 0.1 // For slight curve, optional
            };
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true, // Keep true to respect canvas size, or false to fill container
                plugins: {
                    title: {
                        display: true,
                        text: 'Forecast Models Comparison for Sector: {{ selected_sector | e }}'
                    },
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Year'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Demand Value'
                        },
                        beginAtZero: true // Ensure y-axis starts at 0
                    }
                }
            }
        });
    } else if (ctx) {
        // Optional: Display a message on the canvas if no data
        const canvasCtx = ctx.getContext('2d');
        canvasCtx.font = '16px Arial';
        canvasCtx.textAlign = 'center';
        canvasCtx.fillText('No data available to display chart for this sector.', ctx.width / 2, ctx.height / 2);
    }
</script>
</body>
</html>
