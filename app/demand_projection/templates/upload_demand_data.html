<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload & Configure Demand Data</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: 20px auto; }
        h1, h2, h3 { color: #333; text-align: center; }
        ul.flash-messages { list-style: none; padding: 0; margin-bottom: 15px; }
        li.success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 5px; }
        li.error, li.danger { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 5px; }
        li.warning { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin-bottom: 5px; }
        li.info { background-color: #cce5ff; color: #004085; padding: 10px; border-radius: 4px; margin-bottom: 5px; }

        .button { background-color: #007bff; color: white; padding: 10px 15px; text-decoration: none; border-radius: 4px; border: none; cursor: pointer; font-size: 1em; }
        .button:hover { background-color: #0056b3; }
        .button-save-config { background-color: #28a745; }
        .button-save-config:hover { background-color: #218838; }

        input[type="file"], input[type="text"], input[type="number"], input[type="float"], select { margin-bottom:10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: calc(100% - 18px); box-sizing: border-box; }
        label { font-weight: bold; display: block; margin-top: 10px; margin-bottom: 3px; }

        .nav-link { display: inline-block; margin-top:15px; color: #007bff; text-decoration: none; }
        .nav-link:hover{ text-decoration: underline; }

        .section { border: 1px solid #ddd; padding: 15px; margin-top: 20px; border-radius: 5px; background-color: #f9f9f9; }
        .section h2 { text-align: left; margin-top: 0; font-size: 1.5em; }
        .sector-config { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; background-color: #fff; }
        .sector-config h3 { font-size: 1.2em; margin-top: 0; margin-bottom: 10px; background-color: #f0f0f0; padding: 5px; border-radius: 3px; text-align: left;}
        .model-config { margin-left: 10px; padding-bottom:10px; margin-bottom:10px; border-bottom: 1px dashed #eee; }
        .model-config:last-child { border-bottom: none; }
        .model-config > label { font-weight: normal; display: inline-block; margin-right: 10px;} /* For the main model enable checkbox */
        .model-config input[type="checkbox"] { width: auto; margin-right: 5px;}

        .param-group { margin-left: 20px; margin-top: 5px; }
        .param-group label { font-size: 0.95em; font-weight: normal; display: block; }
        .param-group input, .param-group select { width: auto; padding: 6px; margin-left:0px; margin-right: 5px; max-width: 200px; }
        .param-group small { font-size: 0.85em; color: #555; }

        .file-status-box { padding: 10px; border: 1px solid #ccc; margin-bottom: 15px; border-radius: 4px; }
        .file-status-box.valid { background-color: #d4edda; border-color: #c3e6cb; }
        .file-status-box.invalid { background-color: #f8d7da; border-color: #f5c6cb; }
        .file-status-box.notfound { background-color: #fff3cd; border-color: #ffeeba; }

    </style>
</head>
<body>
    <div class="container">
        <h1>Demand Projection Setup</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {% if not active_project_path %}
            <p class="warning">No project is currently loaded. Please load or create a project first from the <a href="{{ url_for('main.home') }}">home page</a>.</p>
        {% else %}
            <p>Current Project: <strong>{{ current_project_name_g }}</strong></p>

            <div class="section">
                <h2>1. Upload Demand Data Excel File</h2>
                <form method="POST" action="{{ url_for('demand_projection.upload_demand_file') }}" enctype="multipart/form-data">
                    <div>
                        <label for="file">Select .xlsx file (Standardized name after upload: <strong>input_demand_file.xlsx</strong>):</label>
                        <input type="file" id="file" name="file" accept=".xlsx" required>
                    </div>
                    <button type="submit" class="button">Upload/Replace File</button>
                </form>
            </div>

            {% if excel_file_exists %}
                <div class="file-status-box {{ 'valid' if input_file_validated else 'invalid' }}">
                    <strong>Excel File Status:</strong> {{ excel_validation_message }}
                </div>
            {% else %}
                 <div class="file-status-box notfound">
                    <strong>Excel File Status:</strong> {{ excel_validation_message }}
                </div>
            {% endif %}


            {% if input_file_validated and available_sectors %}
            <div class="section">
                <h2>2. Configure Forecast Models</h2>
                <form method="POST" action="{{ url_for('demand_projection.save_demand_configuration_route') }}">

                    <h3>Global Settings</h3>
                    <div>
                        <label for="global_target_years">Target Years (comma-separated, e.g., 2025,2030,2035):</label>
                        <input type="text" id="global_target_years" name="global_target_years"
                               value="{{ demand_config.global_settings.target_years | join(',') }}">
                    </div>
                    <div>
                        <label for="global_forecast_start_year">Forecast Start Year (optional):</label>
                        <input type="number" id="global_forecast_start_year" name="global_forecast_start_year"
                               value="{{ demand_config.global_settings.forecast_start_year if demand_config.global_settings.forecast_start_year is not none else '' }}" placeholder="e.g., {{ (demand_config.historical_data_summary.max_year | default(0, true)) + 1 }}">
                    </div>
                    <div>
                        <input type="checkbox" id="global_exclude_covid" name="global_exclude_covid"
                               {% if demand_config.global_settings.exclude_covid_years %}checked{% endif %}>
                        <label for="global_exclude_covid" style="display:inline; font-weight:normal;">Exclude COVID-19 period years (model specific logic)</label>
                    </div>
                    <hr>

                    <h3>Sector Models</h3>
                    {% for sector in available_sectors %}
                    <div class="sector-config">
                        <h3>Sector: {{ sector }}</h3>
                        {% for model_code, model_details in model_options.items() %}
                            {% set field_name_prefix = sector + '|' + model_code %}
                            {% set current_model_config_list = (demand_config.sector_models.get(sector) or []) | selectattr('model_name', 'equalto', model_code) %}
                            {% set current_model_config = current_model_config_list[0] if current_model_config_list else None %}
                            {% set existing_params = current_model_config.parameters if current_model_config else {} %}

                            <div class="model-config">
                                <input type="checkbox" id="{{ field_name_prefix }}_enabled" name="{{ field_name_prefix }}|enabled"
                                       {% if current_model_config and current_model_config.enabled %}checked{% endif %}>
                                <label for="{{ field_name_prefix }}_enabled">{{ model_details.label }}</label>

                                <div class="param-group">
                                {% for param_name, param_config in model_details.params.items() %}
                                    {% if param_config.type == 'select_with_custom' %}
                                        {% set select_field_name = field_name_prefix + '|' + param_name %}
                                        {% set custom_field_name = field_name_prefix + '|' + param_config.custom_input_name %}
                                        {# Determine current WAM window_size to set the select/custom fields correctly #}
                                        {% set actual_wam_window_size = existing_params.get('window_size', param_config.custom_input_default) | string %}
                                        {% set is_custom_selected = True %}
                                        {% for opt in param_config.options %}
                                            {% if opt.value == actual_wam_window_size and opt.value != 'custom' %}
                                                {% set is_custom_selected = False %}
                                            {% endif %}
                                        {% endfor %}

                                        <label for="{{ select_field_name }}">{{ param_config.label }}:</label>
                                        <select name="{{ select_field_name }}" id="{{ select_field_name }}" class="wam-window-select">
                                            {% for option in param_config.options %}
                                                <option value="{{ option.value }}"
                                                        {% if (is_custom_selected and option.value == 'custom') or (not is_custom_selected and option.value == actual_wam_window_size) %}selected{% endif %}>
                                                    {{ option.label }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <input type="{{ param_config.custom_input_type | default('number') }}"
                                               name="{{ custom_field_name }}"
                                               id="{{ custom_field_name }}"
                                               value="{{ actual_wam_window_size if is_custom_selected else param_config.custom_input_default }}"
                                               min="{{ param_config.custom_input_min | default(1) }}"
                                               max="{{ param_config.custom_input_max | default(20) }}"
                                               class="wam-window-custom-input"
                                               style="display: {% if is_custom_selected %}inline-block{% else %}none{% endif %}; margin-left: 5px;">
                                        <small>(Default custom: {{param_config.custom_input_default}})</small><br>

                                    {% elif param_config.type == 'float' or param_config.type == 'number' %}
                                        {% set input_val = existing_params.get(param_name, param_config.default) %}
                                        <label for="{{ field_name_prefix }}_{{ param_name }}">{{ param_config.label }}:</label>
                                        <input type="{{ param_config.type }}" id="{{ field_name_prefix }}_{{ param_name }}"
                                               name="{{ field_name_prefix }}|{{ param_name }}"
                                               value="{{ input_val if input_val is not none else param_config.default }}"
                                               step="{{ param_config.step | default('any' if param_config.type == 'float' else 1) }}"
                                               min="{{ param_config.min | default('') }}" max="{{ param_config.max | default('') }}">
                                        <small>(Default: {{param_config.default}})</small><br>
                                    {% elif param_config.type == 'text' %}
                                         <label for="{{ field_name_prefix }}_{{ param_name }}">{{ param_config.label }}:</label>
                                         <input type="text" id="{{ field_name_prefix }}_{{ param_name }}"
                                               name="{{ field_name_prefix }}|{{ param_name }}"
                                               value="{{ existing_params.get(param_name, param_config.default) }}">
                                        <small>(Default: {{param_config.default}})</small><br>
                                    {% endif %}
                                {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    <button type="submit" class="button button-save-config" style="margin-top:15px;">Save Demand Configuration</button>
                </form>
            </div>

            <div class="section">
                <h2>3. Run Forecast</h2>
                <form method="POST" action="{{ url_for('demand_projection.run_forecast_route') }}">
                    <div>
                        <label for="scenario_name">Scenario Name:</label>
                        <input type="text" id="scenario_name" name="scenario_name" value="Forecast_{{ datetime.utcnow().strftime('%Y%m%d_%H%M%S') }}" required>
                        <small>A unique name for this forecast run.</small>
                    </div>
                    <button type="submit" class="button" style="margin-top:15px; background-color: #ffc107; color: #212529;">Run Forecast</button>
                </form>
            </div>
            {% elif excel_file_exists and not input_file_validated %}
                 <p class="warning">The uploaded Excel file has validation issues (see message above). Please correct and re-upload before configuring models.</p>
            {% else %}
                <p class="info">Upload a valid demand data Excel file to enable model configuration.</p>
            {% endif %}

        {% endif %} {# End of project loaded check #}
        <hr style="margin-top:30px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="{{ url_for('demand_projection.results_page_route') }}" class="button" style="background-color: #17a2b8;">View Forecast Results</a>
        </div>
        <a href="{{ url_for('main.home') }}" class="nav-link" style="display: block; text-align: center;">Back to Project Home</a>
    </div>

<script>
    // JavaScript for toggling custom input visibility for select_with_custom type
    document.addEventListener('DOMContentLoaded', function() {
        var selects = document.querySelectorAll('select.wam-window-select'); // More specific selector
        selects.forEach(function(selectEl) {
            var customInputId = selectEl.id.replace('_window_size_option', '_window_size_custom'); // Derive custom input ID
            var customInputEl = document.getElementById(customInputId);

            if (customInputEl) {
                // Initial state check
                customInputEl.style.display = (selectEl.value === 'custom') ? 'inline-block' : 'none';

                selectEl.addEventListener('change', function() {
                    customInputEl.style.display = (this.value === 'custom') ? 'inline-block' : 'none';
                    if (this.value !== 'custom') {
                        // Optional: Reset custom input value or set to a default if select changes away from custom
                        // customInputEl.value = customInputEl.defaultValue; // Or specific default from data-attribute
                    }
                });
            }
        });
    });
</script>
</body>
</html>
