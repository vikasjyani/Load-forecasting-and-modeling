<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Compare Demand Scenarios</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 1200px; margin: 20px auto; }
        h1, h2 { text-align: center; color: #333; }
        .selection-form { margin-bottom: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px; text-align: center; }
        .selection-form label { margin-right: 10px; font-weight: bold; }
        .selection-form select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-right: 15px; min-width: 250px; }
        .selection-form button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .selection-form button:hover { background-color: #0056b3; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        td.number, th.number { text-align: right; }

        .chart-container { width: 95%; max-width: 900px; margin: 30px auto; padding:10px; border: 1px solid #ddd; border-radius:5px; background-color:#fdfdfd;}
        .error-message { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-bottom: 20px; text-align: center;}
        .nav-links { margin-top: 30px; text-align: center; }
        .nav-links a { margin: 0 10px; text-decoration: none; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Compare Demand Scenarios</h1>

        {% if not project_name %}
            <p class="error-message">No project is currently loaded. Please load or create a project first from the <a href="{{ url_for('main.home') }}">home page</a>.</p>
        {% else %}
            <p style="text-align:center;">Current Project: <strong>{{ project_name }}</strong></p>

            <form method="GET" action="{{ url_for('demand_projection.compare_scenarios_route') }}" class="selection-form">
                <label for="scenario_a_select">Select Scenario A:</label>
                <select name="scenario_a" id="scenario_a_select">
                    <option value="">-- Select Scenario A --</option>
                    {% for scenario in available_scenarios %}
                        <option value="{{ scenario.id }}" {% if scenario.id == scenario_a_id %}selected{% endif %}>
                            {{ scenario.display_name }}
                        </option>
                    {% endfor %}
                </select>

                <label for="scenario_b_select">Select Scenario B:</label>
                <select name="scenario_b" id="scenario_b_select">
                    <option value="">-- Select Scenario B --</option>
                    {% for scenario in available_scenarios %}
                        <option value="{{ scenario.id }}" {% if scenario.id == scenario_b_id %}selected{% endif %}>
                            {{ scenario.display_name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit">Compare</button>
            </form>

            {% if error_message %}
                <p class="error-message">{{ error_message }}</p>
            {% endif %}

            {% if scenario_a_id and scenario_b_id and not error_message %}
                <h2>Comparison: {{ scenario_a_display_name }} vs. {{ scenario_b_display_name }}</h2>

                {% if plot_data_json and plot_data_json != '{}' %}
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
                {% else %}
                <p style="text-align:center;"><em>Not enough data to generate comparison plot.</em></p>
                {% endif %}

                <h3>Net Demand Comparison by Sector</h3>
                {% if comparison_table %}
                <table>
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Sector</th>
                            <th class="number">Net Demand ({{ scenario_a_display_name.split('(')[0].strip() }})</th>
                            <th class="number">Net Demand ({{ scenario_b_display_name.split('(')[0].strip() }})</th>
                            <th class="number">Difference (A - B)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in comparison_table %}
                        <tr>
                            <td>{{ row.Year }}</td>
                            <td>{{ row.Sector }}</td>
                            <td class="number">{{ "%.2f"|format(row.Net_Demand_A) if row.Net_Demand_A is not none else 'N/A' }}</td>
                            <td class="number">{{ "%.2f"|format(row.Net_Demand_B) if row.Net_Demand_B is not none else 'N/A' }}</td>
                            <td class="number" style="color: {{ 'red' if row['Difference (A-B)'] < 0 else ('green' if row['Difference (A-B)'] > 0 else 'black') }};">
                                {{ "%.2f"|format(row['Difference (A-B)']) if row['Difference (A-B)'] is not none else 'N/A' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="text-align:center;"><em>No detailed sector comparison data available. Ensure primary models are set and T&D losses configured for both scenarios.</em></p>
                {% endif %}

            {% elif available_scenarios %}
                 <p style="text-align:center; font-style:italic;">Please select two different scenarios from the dropdowns above and click "Compare".</p>
            {% else %}
                 <p style="text-align:center; font-style:italic;">No forecast scenarios found for this project. Please run some forecasts first.</p>
            {% endif %}

            <div class="nav-links">
                <a href="{{ url_for('demand_projection.results_page_route') }}">Back to Scenario Results List</a>
                <a href="{{ url_for('main.home') }}">Back to Project Home</a>
            </div>
        {% endif %}
    </div>

<script>
    const plotData = JSON.parse({{ plot_data_json | default('{}') | safe }});
    const comparisonChartCanvas = document.getElementById('comparisonChart');

    if (comparisonChartCanvas && plotData && plotData.years && plotData.years.length > 0) {
        new Chart(comparisonChartCanvas, {
            type: 'line',
            data: {
                labels: plotData.years,
                datasets: [
                    {
                        label: 'Total Net Demand (' + (plotData.scenario_a_name || 'Scenario A') + ')',
                        data: plotData.scenario_a_total_net,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Total Net Demand (' + (plotData.scenario_b_name || 'Scenario B') + ')',
                        data: plotData.scenario_b_total_net,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: { display: true, text: 'Total Net Demand Comparison' },
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { display: true, title: { display: true, text: 'Year' } },
                    y: { display: true, title: { display: true, text: 'Total Net Demand' }, beginAtZero: true }
                }
            }
        });
    } else if (comparisonChartCanvas) {
        const ctx = comparisonChartCanvas.getContext('2d');
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Not enough data or scenarios not fully processed for plotting.', comparisonChartCanvas.width / 2, comparisonChartCanvas.height / 2);
    }
</script>
</body>
</html>
