<!-- templates/load_profile_generation.html -->
{% extends "sidebar_layout.html" %}

{% block title %}Load Profile Generation - {{ project_name }}{% endblock %}

{% block page_header_title %}Load Profile Generation{% endblock %}

{% block additional_css %}
<link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/utilities.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/layout-fixes.css') }}">

<link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar-layout.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/load_profile_generation.css') }}">
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Status Alert -->
    <div id="statusAlert" class="alert alert-info alert-dismissible fade show d-none" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        <span id="statusMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Step 1: Method Selection -->
    <div class="card mb-4" id="methodSelectionCard">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-tools me-2"></i>Step 1: Select Generation Method</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="method-card p-4 text-center" data-method="base_profile_scaling" id="baseMethodCard">
                        <div class="method-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h5>Base Profile Scaling</h5>
                        <p class="text-muted mb-3">Use patterns from a specific historical year and scale with future
                            demand scenarios.</p>
                        <div class="method-features">
                            <small class="text-success"><i class="fas fa-check me-1"></i>Simple and
                                intuitive</small><br>
                            <small class="text-success"><i class="fas fa-check me-1"></i>Preserves seasonal
                                patterns</small><br>
                            <small class="text-success"><i class="fas fa-check me-1"></i>Fast computation</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="method-card p-4 text-center" data-method="stl_decomposition" id="stlMethodCard">
                        <div class="method-icon">
                            <i class="fas fa-wave-square"></i>
                        </div>
                        <h5>STL Decomposition</h5>
                        <p class="text-muted mb-3">Advanced statistical method using trend, seasonal, and residual
                            components.</p>
                        <div class="method-features">
                            <small class="text-success"><i class="fas fa-check me-1"></i>Trend analysis</small><br>
                            <small class="text-success"><i class="fas fa-check me-1"></i>Robust to outliers</small><br>
                            <small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Requires full
                                historical data</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Configuration -->
    <div class="card mb-4 d-none" id="configurationCard">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-cogs me-2"></i>Step 2: Configuration</h4>
        </div>
        <div class="card-body">
            <form id="configurationForm">
                <!-- Method-specific configuration -->
                <div id="baseMethodConfig" class="method-config d-none">
                    <div class="config-section">
                        <h5><i class="fas fa-calendar-alt me-2"></i>Base Year Selection</h5>
                        <p class="text-muted">Select the historical financial year to use as the base pattern.</p>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="baseYear" class="form-label">Base Financial Year</label>
                                <select class="form-select" id="baseYear" name="base_year">
                                    <option value="">Loading available years...</option>
                                </select>
                                <div class="form-text">Choose a complete year with good data quality</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Base Year Preview</label>
                                <button type="button" class="btn btn-outline-primary w-100" id="previewBaseYear">
                                    <i class="fas fa-eye me-2"></i>Preview Patterns
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="stlMethodConfig" class="method-config d-none">
                    <div class="config-section">
                        <h5><i class="fas fa-wave-square me-2"></i>STL Parameters</h5>
                        <p class="text-muted">Configure STL decomposition parameters.</p>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="stlPeriod" class="form-label">Seasonal Period</label>
                                <input type="number" class="form-control" id="stlPeriod" name="stl_period" value="8760"
                                    min="24" max="8760">
                                <div class="form-text">Hours in seasonal cycle (8760 = annual)</div>
                            </div>
                            <div class="col-md-4">
                                <label for="stlSeasonal" class="form-label">Seasonal Smoothing</label>
                                <input type="number" class="form-control" id="stlSeasonal" name="stl_seasonal"
                                    value="13" min="3" max="50">
                                <div class="form-text">Seasonal component smoothing parameter</div>
                            </div>
                            <div class="col-md-4">
                                <label for="stlRobust" class="form-label">Robust Mode</label>
                                <select class="form-select" id="stlRobust" name="stl_robust">
                                    <option value="true">Enabled (recommended)</option>
                                    <option value="false">Disabled</option>
                                </select>
                                <div class="form-text">Robust to outliers</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Demand Source Selection -->
                <div class="config-section">
                    <h5><i class="fas fa-database me-2"></i>Demand Data Source</h5>
                    <p class="text-muted">Choose the source for future demand scenarios.</p>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="demand-source-card" data-source="template">
                                <div class="d-flex align-items-center">
                                    <input type="radio" class="form-check-input me-3" name="demand_source"
                                        value="template" id="demandTemplate">
                                    <div>
                                        <h6 class="mb-1">Template Data</h6>
                                        <small class="text-muted">Use demand data from load_curve_template.xlsx</small>
                                    </div>
                                </div>
                                <div class="mt-2" id="templateInfo">
                                    <small class="text-info">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Click to load template information
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="demand-source-card" data-source="scenario">
                                <div class="d-flex align-items-center">
                                    <input type="radio" class="form-check-input me-3" name="demand_source"
                                        value="scenario" id="demandScenario">
                                    <div>
                                        <h6 class="mb-1">Demand Scenario</h6>
                                        <small class="text-muted">Use results from demand projection module</small>
                                    </div>
                                </div>
                                <div class="mt-2" id="scenarioSelection" style="display: none;">
                                    <select class="form-select form-select-sm" id="scenarioSelect" name="scenario_name">
                                        <option value="">Select scenario...</option>
                                        {% for scenario in available_scenarios %}
                                        <option value="{{ scenario.name }}">{{ scenario.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Range -->
                <div class="config-section">
                    <h5><i class="fas fa-clock me-2"></i>Generation Period</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="startFY" class="form-label">Start Financial Year</label>
                            <input type="number" class="form-control" id="startFY" name="start_fy" value="2025"
                                min="2020" max="2050" required>
                        </div>
                        <div class="col-md-3">
                            <label for="endFY" class="form-label">End Financial Year</label>
                            <input type="number" class="form-control" id="endFY" name="end_fy" value="2035" min="2020"
                                max="2050" required>
                        </div>
                        <div class="col-md-3">
                            <label for="frequency" class="form-label">Output Frequency</label>
                            <select class="form-select" id="frequency" name="frequency">
                                <option value="hourly">Hourly</option>
                                <option value="15min">15 Minutes</option>
                                <option value="30min">30 Minutes</option>
                                <option value="daily">Daily</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="outputUnit" class="form-label">Output Unit</label>
                            <select class="form-select" id="outputUnit" name="output_unit">
                                <option value="kW">kW</option>
                                <option value="MW">MW</option>
                                <option value="GW">GW</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Constraints -->
                <div class="config-section">
                    <h5><i class="fas fa-sliders-h me-2"></i>Optional Constraints</h5>
                    <p class="text-muted">Apply additional constraints to shape the load profile. These will be
                        calculated automatically if not available in template.</p>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="constraint-option" id="monthlyPeaksOption">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="applyMonthlyPeaks"
                                        name="apply_monthly_peaks">
                                    <label class="form-check-label" for="applyMonthlyPeaks">
                                        <strong>Monthly Peak Constraints</strong>
                                    </label>
                                </div>
                                <small class="text-muted">Ensure monthly demand shares match historical patterns</small>
                                <div class="constraint-info" id="monthlyPeaksStatus">
                                    <small class="text-info">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Status will be shown after template analysis
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="constraint-option" id="loadFactorsOption">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="applyLoadFactors"
                                        name="apply_load_factors">
                                    <label class="form-check-label" for="applyLoadFactors">
                                        <strong>Load Factor Constraints</strong>
                                    </label>
                                </div>
                                <small class="text-muted">Apply monthly load factor patterns from historical
                                    data</small>
                                <div class="constraint-info" id="loadFactorsStatus">
                                    <small class="text-info">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Status will be shown after template analysis
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-lightbulb me-2"></i>Smart Constraint Calculation</h6>
                        <p class="mb-2">When constraints are not available in the template file, the system will
                            automatically:</p>
                        <ul class="mb-0">
                            <li><strong>Monthly Shares:</strong> Calculate from historical data using
                                <code>monthly_share = monthly_total_kWh / annual_total_kWh</code></li>
                            <li><strong>Load Factors:</strong> Calculate from historical data using
                                <code>load_factor = average_demand / max_demand</code></li>
                            <li><strong>Future Scaling:</strong> Apply shares to future demand using
                                <code>future_monthly_kWh = future_annual_kWh Ã— monthly_share</code></li>
                        </ul>
                    </div>
                </div>



                <!-- Profile Naming Section -->
                <div class="config-section">
                    <h5><i class="fas fa-tag me-2"></i>Profile Naming</h5>
                    <div class="row">
                        <div class="col-md-8">
                            <label for="customProfileName" class="form-label">Profile Name (Optional)</label>
                            <input type="text" class="form-control" id="customProfileName" name="custom_name"
                                placeholder="e.g., High_Growth_Scenario_2025" maxlength="50">
                            <div class="form-text">
                                Enter a custom name for your load profile. If empty, an automatic name will be
                                generated.
                                <br><small class="text-muted">Only letters, numbers, spaces, hyphens and underscores are
                                    allowed.</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Name Preview</label>
                            <div class="bg-light p-2 rounded border" id="namePreview">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Preview will appear here
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

        
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5" id="generateProfileBtn">
                        <i class="fas fa-play me-2"></i>Generate & Save Load Profile
                    </button>
                    <div class="mt-2">
                        <small class="text-muted">
                            Profile will be saved to: <code>results/load_profiles/</code>
                        </small>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-container" id="progressContainer">
        <h4 class="text-center mb-4"><i class="fas fa-cogs me-2"></i>Generating Load Profile</h4>

        <div class="step-indicator">
            <div class="step" id="step1">
                <i class="fas fa-upload"></i><br>
                <small>Loading Data</small>
            </div>
            <div class="step" id="step2">
                <i class="fas fa-chart-line"></i><br>
                <small>Processing Patterns</small>
            </div>
            <div class="step" id="step3">
                <i class="fas fa-sliders-h"></i><br>
                <small>Applying Constraints</small>
            </div>
            <div class="step" id="step4">
                <i class="fas fa-check-circle"></i><br>
                <small>Finalizing</small>
            </div>
        </div>

        <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"
                id="progressBar">
                0%
            </div>
        </div>

        <div class="text-center">
            <p id="progressMessage">Initializing profile generation...</p>
            <button type="button" class="btn btn-outline-secondary" id="cancelGeneration">
                <i class="fas fa-times me-2"></i>Cancel
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div class="card d-none" id="resultsCard">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-chart-area me-2"></i>Generated Load Profile</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5>Profile Visualization</h5>
                    <canvas id="profileChart" width="800" height="400"></canvas>
                </div>
                <div class="col-md-4">
                    <h5>Profile Statistics</h5>
                    <div class="bg-light p-3 rounded" id="profileStats">
                        <!-- Stats will be populated here -->
                    </div>

                    <h5 class="mt-4">Validation Results</h5>
                    <div class="bg-light p-3 rounded" id="validationResults">
                        <!-- Validation will be populated here -->
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-primary w-100 mb-2" id="downloadProfile">
                            <i class="fas fa-download me-2"></i>Download CSV
                        </button>
                        <button class="btn btn-outline-secondary w-100" id="generateAnother">
                            <i class="fas fa-plus me-2"></i>Generate Another
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Saved Profiles Section -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0"><i class="fas fa-archive me-2"></i>Saved Load Profiles</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="savedProfilesTable">
                    <thead>
                        <tr>
                            <th>Profile ID</th>
                            <th>Method</th>
                            <th>Generated</th>
                            <th>Period</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for profile in saved_profiles %}
                        <tr>
                            <td>
                                <strong>{{ profile.profile_id }}</strong>
                                <br><small class="text-muted">{{ profile.get('method', 'Unknown') }}</small>
                            </td>
                            <td>
                                <span
                                    class="badge bg-{% if profile.get('method') == 'base_profile_scaling' %}primary{% else %}success{% endif %}">
                                    {{ profile.get('method', 'Unknown').replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td>{{ profile.get('generated_at', 'Unknown')[:10] if profile.get('generated_at') else
                                'Unknown' }}</td>
                            <td>{{ profile.get('metadata', {}).get('start_fy', 'N/A') }} - {{ profile.get('metadata',
                                {}).get('end_fy', 'N/A') }}</td>
                            <td>{{ "%.1f MB"|format(profile.get('file_info', {}).get('size_mb', 0)) }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary view-profile"
                                        data-profile-id="{{ profile.profile_id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success download-profile"
                                        data-profile-id="{{ profile.profile_id }}">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-profile"
                                        data-profile-id="{{ profile.profile_id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>No saved profiles found. Generate your first load
                                profile above.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Base Year Preview Modal -->
<div class="modal fade" id="baseYearPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Base Year Load Patterns Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="baseYearPreviewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Profile View Modal -->
<div class="modal fade" id="profileViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Load Profile Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="profileViewContent">
                    <!-- Profile content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/load_profile_generation.js') }}"></script>
{% endblock %}